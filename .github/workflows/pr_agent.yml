name: PR Agent Review

on:
  pull_request:
    types: [opened, reopened, ready_for_review, synchronize]
  issue_comment:
    types: [created]

jobs:
  pr_agent_job:
    if: ${{ github.event.sender.type != 'Bot' }}
    runs-on: [self-hosted, windows, ollama]
    permissions:
      issues: write
      pull-requests: write
      contents: write
    name: Run PR Agent
    steps:
      - name: Ensure Ollama is running
        shell: powershell
        run: |
          $process = Get-Process -Name "ollama" -ErrorAction SilentlyContinue
          if (-not $process) {
            Write-Host "Starting Ollama..."
            Start-Process -FilePath "ollama" -ArgumentList "serve" -WindowStyle Hidden
            Start-Sleep -Seconds 5
          }
          try {
            $response = Invoke-RestMethod -Uri "http://localhost:11434/api/tags" -Method Get
            Write-Host "Ollama is running"
          } catch {
            Write-Error "Ollama is not accessible!"
            exit 1
          }

      - name: PR Agent action step
        id: pragent
        uses: qodo-ai/pr-agent@main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          config.model: "ollama/qwen2.5-coder:7b"
          config.fallback_models: '["ollama/qwen2.5-coder:7b"]'
          config.custom_model_max_tokens: "32000"
          OLLAMA.API_BASE: "http://localhost:11434"
          config.duplicate_examples: "true"
          github_action_config.auto_review: "true"
          github_action_config.auto_describe: "true"
          github_action_config.auto_improve: "true"
          github_action_config.pr_actions: '["opened", "reopened", "ready_for_review"]'
